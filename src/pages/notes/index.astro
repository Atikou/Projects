---
import { getCollection, type CollectionEntry } from "astro:content";
import NoteCard from "../../components/NoteCard.astro";
import type { Note } from "../../components/NoteCard.astro";

import "../../styles/notes.css";

type NoteEntry = CollectionEntry<"notes">;

const entries: CollectionEntry<"notes">[] = await getCollection(
  "notes",
  (entry: NoteEntry) => !entry.data.draft
);

const toDate = (v: unknown): Date => {
  if (v instanceof Date) return v;
  const d = new Date(v as any);
  return Number.isNaN(d.getTime()) ? new Date(0) : d;
};
// 筛选并排序笔记
const notes: Note[] = entries
  .slice()
  .sort(
    (a: NoteEntry, b: NoteEntry) =>
      toDate(b.data.date).getTime() - toDate(a.data.date).getTime()
  )
  .map((e: NoteEntry): Note => {
    const base = import.meta.env.BASE_URL.replace(/\/$/, "");
    const cover =
      e.data.cover && e.data.cover.startsWith("/")
        ? `${base}${e.data.cover}`
        : e.data.cover;

    return {
      title: e.data.title,
      slug: e.slug,
      description: e.data.description ?? "",
      cover,
      tags: e.data.tags ?? [],
      date: toDate(e.data.date),
    };
  });

const tags = Array.from(new Set(notes.flatMap((n) => n.tags))).sort((a, b) =>
  a.localeCompare(b, "zh-Hans-CN")
);

const url = new URL(Astro.request.url);
const q = (url.searchParams.get("q") ?? "").trim();
const activeTag = (url.searchParams.get("tag") ?? "").trim();
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>笔记</title>
    <meta
      name="description"
      content="项目/设计/工程/流程相关的游戏开发笔记。"
    />
  </head>
  <body>
    <div class="bg" aria-hidden="true"></div>

    <main class="wrap">
      <header class="hero">
        <div>
          <p class="kicker">NOTES</p>
          <h1>笔记</h1>
          <p class="sub">项目复盘、设计记录、工程与流程沉淀。</p>
        </div>

        <div class="badge">
          <span class="num">{notes.length}</span>
          <span class="lbl">篇</span>
        </div>
      </header>

      <section class="panel">
        <form class="filters" method="get">
          <label class="search" aria-label="搜索">
            <span class="icon" aria-hidden="true">⌕</span>
            <input
              type="search"
              name="q"
              placeholder="搜索标题 / 标签 / 简介…"
              value={q}
            />
            {activeTag && <input type="hidden" name="tag" value={activeTag} />}
          </label>

          <nav class="chips" aria-label="标签筛选">
            <a
              class={`chip ${!activeTag ? "active" : ""}`}
              href={`./${q ? `?q=${encodeURIComponent(q)}` : ""}`}
            >
              全部
            </a>

            {
              tags.map((t) => {
                const params = new URLSearchParams();
                if (q) params.set("q", q);
                params.set("tag", t);
                return (
                  <a
                    class={`chip ${activeTag === t ? "active" : ""}`}
                    href={`./?${params.toString()}`}
                  >
                    {t}
                  </a>
                );
              })
            }
          </nav>
        </form>

        <div class="bar">
          <div class="hint">
            共 <b>{notes.length}</b> 条
            {
              activeTag ? (
                <>
                  {" "}
                  · 标签：<b>{activeTag}</b>
                </>
              ) : null
            }
            {
              q ? (
                <>
                  {" "}
                  · 关键词：<b>{q}</b>
                </>
              ) : null
            }
          </div>

          {
            (activeTag || q) && (
              <a class="clear" href="./">
                清除
              </a>
            )
          }
        </div>

        <section class="grid" aria-label="笔记列表">
          {notes.map((note) => <NoteCard note={note} />)}
        </section>
      </section>
    </main>
  </body>
</html>
