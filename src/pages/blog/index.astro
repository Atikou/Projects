---
import "../../styles/gamepunk.css";
import { getCollection, type CollectionEntry } from "astro:content";

const brand = "ATIKOU";
const pageTitle = "åšå®¢";
const pageSubtitle = "BLOG Â· Devlog / å¤ç›˜ / çµæ„Ÿ";

type BlogEntry = CollectionEntry<"blog">;

type PostItem = {
  title: string;
  description: string;
  date: Date;
  dateText: string;
  tags: string[];
  url: string;
};

const entries: BlogEntry[] = await getCollection(
  "blog",
  (entry: BlogEntry) => !entry.data.draft
);
const toDate = (v: unknown): Date => {
  if (v instanceof Date) return v;
  const d = new Date(v as any);
  return Number.isNaN(d.getTime()) ? new Date(0) : d;
};
const posts: PostItem[] = entries
  .slice()
  .sort((a: BlogEntry, b: BlogEntry) => b.data.date.getTime() - a.data.date.getTime())
  .map((e: BlogEntry): PostItem => ({
    title: e.data.title,
    description: e.data.description ?? "",
    date: toDate(e.data.date),
    dateText: toDate(e.data.date).toISOString().slice(0, 10),
    tags: e.data.tags ?? [],
    url: `../../content/blog/${e.slug}/`,
  }));

const recommended: PostItem[] = posts.slice(0, 10);
---

<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <title>{brand} Â· {pageTitle}</title>
  </head>

  <body>
    <div class="fx"></div>
    <div class="noise"></div>

    <div class="wrap">
      <header>
        <a class="logo" href="../" aria-label="Home">
          <span class="chip" aria-hidden="true"></span>
          <span>NEON NODE // {brand}</span>
        </a>

        <nav class="mini-nav" aria-label="Quick nav">
          <a class="mini" href="../projects/"><span aria-hidden="true">âŒ¬</span> Projects</a>
          <a class="mini" href="./"><span aria-hidden="true">âœ¶</span> Blog</a>
          <a class="mini" href="../notes/"><span aria-hidden="true">âŒ</span> Notes</a>
        </nav>
      </header>

      <section class="hero">
        <div class="card neon main">
          <p class="kicker">{pageSubtitle}</p>

          <h1 class="title">
            <span class="glitch" data-text={pageTitle}>{pageTitle}</span>
          </h1>

          <p class="desc">
            å½“å‰å…± <code>{posts.length}</code> ç¯‡æ–‡ç« ï¼ˆå·²éšè— draftï¼‰ã€‚
          </p>

          <div class="cta">
            <a class="btn primary" href="../"><span class="dot" aria-hidden="true"></span>è¿”å›é¦–é¡µ</a>
            <a class="btn" href="../notes/"><span class="dot" aria-hidden="true"></span>å»çœ‹ç¬”è®°</a>
          </div>

          <div class="grid" aria-label="Posts">
            {posts.length === 0 ? (
              <div class="nav" style="grid-column: span 12;">
                <div class="top">
                  <h2 class="cn">æš‚æ— æ–‡ç« </h2>
                  <p class="en">EMPTY</p>
                </div>
                <p class="hint">
                  åœ¨ <code>src/content/blog/</code> æ–°å»º mdï¼Œå¹¶å¡«å¥½ <code>title / date</code>ã€‚
                </p>
              </div>
            ) : (
              posts.map((p: PostItem) => (
                <a class="nav" href={p.url}>
                  <div class="top">
                    <h2 class="cn">{p.title}</h2>
                    <p class="en">{p.dateText}</p>
                  </div>
                  <p class="hint">
                    {p.description || "ï¼ˆæš‚æ— ç®€ä»‹ï¼‰"}
                    {p.tags.length > 0 ? (
                      <>
                        <br />
                        <span style="opacity:.8;">#{p.tags.slice(0, 3).join(" #")}</span>
                      </>
                    ) : null}
                  </p>
                </a>
              ))
            )}
          </div>
        </div>

        <div class="side-stack">
          <aside class="card side">
            <div class="poster" aria-label="Blog artwork placeholder"></div>
            <p>
              æ–‡ç« æ¥è‡ª <code>src/content/blog</code>ã€‚
              <br />
              å»ºè®®éƒ½å†™ <code>description/tags</code>ï¼Œåˆ—è¡¨æ›´å¥½çœ‹ã€‚
            </p>
          </aside>

          <aside class="card side recommend" aria-label="Recommendations">
            <h3 class="rec-title">æ¨èé˜…è¯»</h3>
            <ul class="rec-list">
              {recommended.length === 0 ? (
                <li><a href="#">æš‚æ— æ¨è</a></li>
              ) : (
                recommended.map((p: PostItem) => (
                  <li><a href={p.url}>ğŸ“˜ {p.title}</a></li>
                ))
              )}
            </ul>
          </aside>
        </div>
      </section>

      <footer>
        <div>Â© {new Date().getFullYear()} {brand} Â· Built with Astro</div>
        <div>é‚®ç®± <a href="mailto:formcyy@outlook.com">formcyy@outlook.com</a></div>
      </footer>
    </div>
  </body>
</html>
